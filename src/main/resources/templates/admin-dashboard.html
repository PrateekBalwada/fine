<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    background: #f5f7fa;
    color: #1f3b57;
  }

  h1 {
    text-align: center;
    color: #1f3b57;
    margin-bottom: 20px;
    font-weight: 600;
  }

  .dashboard-card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    padding: 30px;
    margin-bottom: 30px;
  }

  p#overview {
    font-size: 18px;
    margin-bottom: 25px;
    text-align: center;
    color: #1f3b57;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }

  table th, table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
  }

  table th {
    background-color: #e6f2ff;
    color: #1f3b57;
  }

  table td {
    color: #1f3b57;
  }

  table tr:hover {
    background-color: #f1f7ff;
  }

  h3 {
    margin-top: 30px;
    margin-bottom: 15px;
    color: #1f3b57;
    font-weight: 500;
  }

  button.delete-btn {
    padding: 5px 10px;
    background: #ff4d4f;
    border: none;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    transition: background 0.3s;
  }

  button.delete-btn:hover {
    background: #e63946;
  }
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="/">Finexus</a>
        <div class="collapse navbar-collapse justify-content-end">
            <ul class="navbar-nav">
                <li class="nav-item" id="navUser" style="display:none;">
                    <a class="nav-link disabled" href="#">Hello, <span id="userFullName"></span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/signin" onclick="signOut()">Sign Out</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-5">
  <div class="dashboard-card">
    <h1>Admin Dashboard</h1>
    <p id="overview"></p>

    <h3>Users</h3>
    <table class="table table-striped" id="usersTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
          <th>AccountId</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Add User Form -->
    <div class="mt-4 mb-4">
      <h4>Add New User</h4>
      <form id="addUserForm" onsubmit="addUser(event)" class="row g-3">
        <div class="col-md-6">
          <label for="newUsername" class="form-label">Username</label>
          <input type="text" class="form-control" id="newUsername" required>
        </div>
        <div class="col-md-6">
          <label for="newEmail" class="form-label">Email</label>
          <input type="email" class="form-control" id="newEmail" required>
        </div>
        <div class="col-md-6">
          <label for="newPassword" class="form-label">Password</label>
          <input type="password" class="form-control" id="newPassword" required>
        </div>
        <div class="col-md-6">
          <label for="newRole" class="form-label">Role</label>
          <select class="form-select" id="newRole">
            <option value="USER">USER</option>
            <option value="ADMIN">ADMIN</option>
          </select>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Add User</button>
        </div>
      </form>
    </div>

    <h3>Accounts</h3>
    <table class="table table-striped" id="accountsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Holder</th>
          <th>Balance</th>
          <th>UserId</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const token = localStorage.getItem('jwtToken');
if (!token) {
  alert('Please login as admin');
  window.location.href = '/admin-login.html';
}

// -------------------- Overview --------------------
async function loadOverview() {
  const res = await fetch('/api/admin/overview', { headers: { 'Authorization': 'Bearer ' + token }});
  if (!res.ok) {
    alert('Not authorized or token invalid');
    localStorage.removeItem('jwtToken');
    window.location.href = '/admin-login.html';
    return;
  }
  const o = await res.json();
  document.getElementById('overview').innerText = 'Users: ' + o.userCount + '  |  Total balance: ' + o.totalBalance;
}

// -------------------- Users --------------------
async function loadUsers() {
  const res = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + token }});
  const users = await res.json();
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';

  users.forEach(u => {
    const row = `<tr>
      <td>${u.id}</td>
      <td>${u.username}</td>
      <td>${u.email || 'N/A'}</td>
      <td>${u.role}</td>
      <td>${u.accountId ?? ''}</td>
      <td><button class="delete-btn" onclick="deleteUser(${u.id})">Delete</button></td>
    </tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
  });
}

// -------------------- Delete User --------------------
async function deleteUser(userId) {
  if (!confirm("Are you sure you want to delete this user?")) return;

  const res = await fetch(`/api/admin/users/${userId}`, {
    method: "DELETE",
    headers: { 'Authorization': 'Bearer ' + token }
  });

  if (!res.ok) {
    alert("Failed to delete user");
    return;
  }

  alert("User deleted successfully");
  loadUsers(); // refresh table
}

// -------------------- Accounts --------------------
async function loadAccounts() {
  const res = await fetch('/api/admin/accounts', { headers: { 'Authorization': 'Bearer ' + token }});
  const accounts = await res.json();
  const tbody = document.querySelector('#accountsTable tbody');
  tbody.innerHTML = '';

  accounts.forEach(a => {
    const row = `<tr>
      <td>${a.id}</td>
      <td>${a.accountHolderName}</td>
      <td>${a.balance}</td>
      <td>${a.userId ?? ''}</td>
    </tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
  });
}

// -------------------- Add User --------------------
async function addUser(event) {
  event.preventDefault();
  
  const username = document.getElementById('newUsername').value;
  const email = document.getElementById('newEmail').value;
  const password = document.getElementById('newPassword').value;
  const role = document.getElementById('newRole').value;

  const userData = {
    username: username,
    email: email,
    password: password,
    role: role
  };

  try {
    const res = await fetch('/api/admin/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify(userData)
    });

    const result = await res.json();

    if (res.ok) {
      alert('User created successfully!');
      document.getElementById('addUserForm').reset();
      loadUsers(); // Refresh the users table
    } else {
      alert('Error: ' + (result.error || 'Failed to create user'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

// -------------------- Initialize --------------------
loadOverview();
loadUsers();
loadAccounts();
</script>

</body>
</html>
